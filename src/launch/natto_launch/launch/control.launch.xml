<launch>
    <arg name="chassis_type" default=""/>
    <arg name="chassis_param_path" default=""/>
    <arg name="control_param_path" default=""/>
    <arg name="planning_param_path" default=""/>
    <arg name="current_pose_topic" default="/localization/current_pose"/>
    <arg name="use_joy_control" default="false"/>

    <let name="control_source_topic" value="/control/command_velocity" unless="$(var use_joy_control)"/>
    <let name="control_source_topic" value="/controller/command_velocity" if="$(var use_joy_control)"/>

    <node_container pkg="rclcpp_components" exec="component_container" name="control_container" namespace="control">
        <!-- オドメトリ -->
        <composable_node pkg="natto_wheel_odometry" plugin="$(var chassis_type)_odometry::$(var chassis_type)_odometry" name="$(var chassis_type)_odometry" namespace="localization/$(var chassis_type)_odometry">
            <param from="$(var chassis_param_path)"/>
            <param name="frame_id" value="odom"/>
            <param name="child_frame_id" value="base_link"/>
            <remap from="$(var chassis_type)_result" to="/$(var chassis_type)/result"/>
        </composable_node>

        <!-- 目標計算 -->
        <composable_node pkg="natto_chassis_calculator" plugin="$(var chassis_type)_calculator::$(var chassis_type)_calculator" name="calculator" namespace="/control/$(var chassis_type)">
            <param from="$(var chassis_param_path)"/>
            <remap from="$(var chassis_type)_command" to="/$(var chassis_type)/command"/>
            <remap from="$(var chassis_type)_result" to="/$(var chassis_type)/result"/>
            <remap from="command_velocity" to="$(var control_source_topic)"/>
        </composable_node>

        <!-- 経路計算 -->
        <composable_node pkg="natto_astar_planner" plugin="astar_planner::astar_planner" name="astar_planner" namespace="/planning">
            <param from="$(var planning_param_path)"/>
            <remap from="occupancy_grid" to="/common/occupancy_grid"/>
            <remap from="goal_pose" to="/goal_pose"/>
            <remap from="current_pose" to="$(var current_pose_topic)"/>
            <remap from="path" to="/planning/path"/>
            <remap from="footprint" to="/common/footprint"/>
        </composable_node>

        <!-- 経路追従 -->
        <composable_node pkg="natto_holonomic_pure_pursuit" plugin="holonomic_pure_pursuit::holonomic_pure_pursuit" name="holonomic_pure_pursuit" namespace="/control">
            <param from="$(var control_param_path)"/>
            <remap from="current_pose" to="$(var current_pose_topic)"/>
            <remap from="path" to="/planning/path"/>
        </composable_node>

        <!-- joy変換 -->
        <composable_node pkg="natto_joy" plugin="joy_to_twist::joy_to_twist" name="joy_to_twist" if="$(var use_joy_control)">
            <param name="max_xy_speed_m_s" value="4.0"/>
            <param name="max_theta_speed_rad_s" value="3.0"/>
            <remap from="joy" to="/joy"/>
            <remap from="command_velocity" to="/controller/command_velocity"/>
        </composable_node>
    </node_container>

    <node pkg="joy" exec="game_controller_node" name="joy" output="screen" if="$(var use_joy_control)"/>
</launch>